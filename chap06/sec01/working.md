---
use_math: true
---

# Working
Before going into further detail, let's first define what base signal should be generated and repeated by the PWM peripheral. Consider the signal shown in the figure below.

<div id="pwmTermPlot" style="grid-column-start: 1; grid-column-end: 2;"></div>
<script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="{{ '/assets/js/jsAnim.js'|relative_url }}"></script>
<script src="js/pwmTerm.js"></script>

Following variables define the base signal,
- $t_H$ is the time period of the base signal for which the signal is `HIGH`.
- $t_L$ is the time period of the base signal for which the signal is `LOW`.
- $p = t_H + t_L$ represents the time period of the base signal. The inverse of $p$, i.e. $1/p$, is the frequency of the PWM signal, $f_{PWM}$.
- The ratio of $t_H$ to $p$ is known as the duty cycle, $D = \frac{t_H}{p} \cdot 100\% $

Most of the PWM peripheral implementations allow the configuration of the base signal through 3 values. For the RP2040 &mu;C, the three values are called
- Clock Divider value, `DIV`
- Counter Wrap value, `TOP`
- Counter Compare value, `CC`
```{note}
The terminology might be slightly different in each &mu;C's datasheet although the operation is pretty similar.
```

## Clock Divider Value `DIV`
As discussed previously, every &mu;C relies on a clock signal, referred to as **system clock** in this section, to function correctly. The clock signal frequency for RP2040 is set to 125MHz by default. The Clock Divider in PWM peripheral takes in this high frequency signal and divides it with a certain number to generate a lower frequency signal, referred to as **frequency divided clock** in this section. This number is the `DIV` value that can be specified through software. For RP2040, this value is split into an 8-bit integer part, 1 &leq; `DIV`<sub>`i`</sub> &leq; 255, and a 4-bit fractional part, 0 &leq; `DIV`<sub>`f`</sub> &leq; 15. Thus, the `DIV` value is defined as

$$\begin{equation*}
    \mathtt{DIV} = \mathtt{DIV}_{\mathtt{i}} + \frac{\mathtt{DIV}_{\mathtt{f}}}{16} \leq 255 \frac{15}{16}
\end{equation*}
$$

And, the frequency of the output clock is
$$\begin{equation*}
    f_{div} = \frac{f_{sys}}{\mathtt{DIV}_{\mathtt{i}} + \frac{\mathtt{DIV}_{\mathtt{f}}}{16}}
\end{equation*}$$
Let's take an example. Following animation show the output signal from the clock divider if the integer part is set to 7 and the fractional part is set to 9. Basically, 7.5625 cycles of the system clock make one cycle of the frequency divided clock.

<div style="display: grid; grid-template-rows: auto 40px;">
    <div style="display: grid; grid-template-columns: 1fr 0.3fr 1fr;">
        <div id="clkDivSysClk" style="grid-column-start: 1; grid-column-end: 2;"></div>
        <div id="clkDivClkDiv" style="grid-column-start: 2; grid-column-end: 3; background: rgba(245, 126, 36, 0.6); border: 5px solid rgba(245, 126, 36, 1); border-radius: 20px; text-align: center; color: white; font-family: serif; font-size: 24px; vertical-align: middle; justify-self: center; align-self: center;">Clock<br>Divider<br>7<sup>9</sup>&frasl;<sub>16</sub></div>
        <div id="clkDivDivClk" style="grid-column-start: 3; grid-column-end: 4;"></div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr">
        <button onClick="clkDivAnim.decreaseAnimUpdateDt()" class="js-anim">&#x23EA;</button>
        <button onClick="clkDivAnim.playPauseAnim()" class="js-anim">&#x23EF;</button>
        <button onClick="clkDivAnim.callResetFuns()" class="js-anim">&#x1F504;</button>
        <button onClick="clkDivAnim.increaseAnimUpdateDt()" class="js-anim">&#x23E9;</button>
    </div>
</div>
<script src="js/clkDiv.js"></script>


## Counter Wrap Value `TOP`
The number of cycles, of the frequency divided clock, generated by the clock divider is counted and stored as a `CTR` value. However, this value can only reach `TOP` value, after which the `CTR` value falls back to 0 and starts increasing again. Following animation shows this process, assuming `DIV` was set to 125 and `TOP` was set to 99.

<div style="display: grid; grid-template-rows: auto 40px;">
    <div style="display: grid; grid-template-columns: 1fr 0.5fr;">
        <div id="ctrWrapDivClk" style="grid-column-start: 1; grid-column-end: 2;"></div>
        <div style="display: grid; grid-template-columns: auto auto auto; grid-column-start: 2; grid-column-end: 3; justify-self: center; align-self: center;">
            <div style="display: grid; grid-template-rows: auto auto; justify-items: center; align-items: center; justify-self: center; align-self: center; vertical-align: middle;">
                <label for="ctrWrapCtrReg" class="js-anim"><span style="font-family: 'Courier New', Courier, monospace; color: white">CTR</span></label>
                <input type="text" class="js-anim" id="ctrWrapCtrReg" minlength="1" maxlength="5" value="0" size="5" disabled>
            </div>
            <div style="justify-self: center; align-self: center; vertical-align: middle; margin: 10px; color: white; font-size: 24px;">\(\leq\)</div>
            <div style="display: grid; grid-template-rows: auto auto; justify-items: center; align-items: center; justify-self: center; align-self: center; vertical-align: middle;">
                <label for="ctrWrapTopReg"  class="js-anim"><span style="font-family: 'Courier New', Courier, monospace; color: white">TOP</span></label>
                <input type="text" class="js-anim" id="ctrWrapTopReg" minlength="1" maxlength="5" value="99" size="5" disabled>
            </div>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr">
        <button onClick="ctrWrapAnim.decreaseAnimUpdateDt()" class="js-anim">&#x23EA;</button>
        <button onClick="ctrWrapAnim.playPauseAnim()" class="js-anim">&#x23EF;</button>
        <button onClick="ctrWrapAnim.callResetFuns()" class="js-anim">&#x1F504;</button>
        <button onClick="ctrWrapAnim.increaseAnimUpdateDt()" class="js-anim">&#x23E9;</button>
    </div>
</div>
<script src="js/ctrWrap.js"></script>

```{note}
It takes one clock cycle for the `CTR` value to fall back to 0.
```
The time it takes for the `CTR` value to start from 0, reach the `TOP` value, and then fall back to 0, is the time period $p$ of the PWM base signal. It can be defined as

$$\begin{equation*}
p = \frac{\mathtt{TOP} + 1}{f_{div}}
\end{equation*}$$

The `TOP` value is a 16-bit number, i.e. 0 &leq; `TOP` &leq; 65535.

## Counter Compare Value `CC`
Now that the time period of the base signal is defined, all that is remaining is to define for how long the signal will be `HIGH` or `LOW`. This is done using the counter compare value. The GPIO, that is being controlled by the PWM peripheral, is set to `HIGH` when the `CTR` value starts increasing from 0. This `HIGH` state is maintained until the `CTR` value becomes equal to the `CC` value. The GPIO is set to `LOW` when this happens. Following animation shows this process, assuming `DIV` was set to 125, `TOP` was set to 9 and `CC` was set to 3.

<div style="display: grid; grid-template-rows: auto 40px;">
    <div style="display: grid; grid-template-columns: 0.4fr 1fr;">
        <div style="display: grid; grid-template-rows: auto auto auto; justify-self: center; align-self: center;">
            <div style="display: grid; grid-template-rows: auto auto; justify-items: center; align-items: center; justify-self: center; align-self: center; vertical-align: middle;">
                <label for="ctrCmpCcReg" class="js-anim"><span style="font-family: 'Courier New', Courier, monospace; color: white">CC</span></label>
                <input type="text" class="js-anim" id="ctrCmpCcReg" minlength="1" maxlength="5" value="3" size="5" disabled>
            </div><br>
            <div style="display: grid; grid-template-rows: auto auto; justify-items: center; align-items: center; justify-self: center; align-self: center; vertical-align: middle;">
                <label for="ctrCmpCtrReg" class="js-anim"><span style="font-family: 'Courier New', Courier, monospace; color: white">CTR</span></label>
                <input type="text" class="js-anim" id="ctrCmpCtrReg" minlength="1" maxlength="5" value="0" size="5" disabled>
            </div><br>
            <div style="display: grid; grid-template-rows: auto auto; justify-items: center; align-items: center; justify-self: center; align-self: center; vertical-align: middle;">
                <label for="ctrCmpTopReg" class="js-anim"><span style="font-family: 'Courier New', Courier, monospace; color: white">TOP</span></label>
                <input type="text" class="js-anim" id="ctrCmpTopReg" minlength="1" maxlength="5" value="9" size="5" disabled>
            </div>
        </div>
        <div id="ctrCmpPwmOut"></div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr">
        <button onClick="ctrCmpAnim.decreaseAnimUpdateDt()" class="js-anim">&#x23EA;</button>
        <button onClick="ctrCmpAnim.playPauseAnim()" class="js-anim">&#x23EF;</button>
        <button onClick="ctrCmpAnim.callResetFuns()" class="js-anim">&#x1F504;</button>
        <button onClick="ctrCmpAnim.increaseAnimUpdateDt()" class="js-anim">&#x23E9;</button>
    </div>
</div>
<script src="js/ctrCmp.js"></script>

This defines both the duty cycle, $D$, and the `HIGH` time, $t_H$, of the base signal as given below

$$\begin{gather*}
D = \frac{\mathtt{CC}}{\mathtt{TOP} + 1} \cdot 100\% \\
t_H = \frac{\mathtt{CC}}{f_{sys}} \cdot \mathtt{DIV}
\end{gather*}$$

The `CC` value is also a 16-bit number, i.e. 0 &leq; `CC` &leq; 65535. Also note that if `CC` is 0 then the PWM output is always `LOW` and if `CC` &gt; `TOP` then the PWM output is always `HIGH`.
